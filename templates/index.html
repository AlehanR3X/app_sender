<!-- Modificación de la sección del formulario y el script -->
<script>
    // Referencias al DOM
    const startBtn = document.getElementById('startBtn');
    const dataField = document.getElementById('data');
    const progressBar = document.getElementById('progress');
    const notification = document.getElementById('notification');

    // Temporizador visible
    const timerDisplay = document.createElement('div');
    timerDisplay.id = 'timerDisplay';
    timerDisplay.style.textAlign = 'center';
    timerDisplay.style.marginTop = '15px';
    timerDisplay.style.fontSize = '16px';
    dataField.parentNode.insertBefore(timerDisplay, dataField.nextSibling);

    // Función para mostrar timer
    function updateTimer(seconds) {
        timerDisplay.textContent = `Siguiente envío en: ${seconds}s`;
    }

    // Función para iniciar el envío
    startBtn.addEventListener('click', async () => {
        const prefix = document.getElementById('prefix').value.trim();
        const lines = dataField.value.split('\n').filter(line => line.trim());
        const destination = document.getElementById('destination').value;
        const sleepTime = parseInt(document.getElementById('sleepSlider').value, 10);

        if (!prefix || lines.length === 0 || !destination) {
            notification.textContent = 'Por favor completa todos los campos!';
            notification.style.display = 'block';
            return;
        }

        // Enviar cada línea con un temporizador
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            if (!line) continue;

            // Mostrar temporizador para el siguiente envío
            let countdown = sleepTime;
            updateTimer(countdown);

            const interval = setInterval(() => {
                countdown--;
                updateTimer(countdown);
                if (countdown <= 0) clearInterval(interval);
            }, 1000);

            // Enviar la línea actual
            try {
                const response = await fetch('/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prefix, lines: [line], destination, sleep_time: sleepTime })
                });
                const result = await response.json();
                if (result.error) {
                    alert(`Error: ${result.error}`);
                    break;
                }

                // Eliminar línea enviada del textarea
                lines[i] = null;
                dataField.value = lines.filter(Boolean).join('\n');
            } catch (error) {
                alert('Error en la comunicación con el servidor.');
            }

            // Esperar el tiempo configurado antes de continuar
            await new Promise(resolve => setTimeout(resolve, sleepTime * 1000));
        }

        // Reiniciar temporizador y mostrar mensaje final
        updateTimer(0);
        notification.textContent = 'Envío completado!';
        notification.style.display = 'block';
    });
</script>
